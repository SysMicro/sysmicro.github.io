<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Protein Control - E. coli RNA Polymerase Music</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Courier New', monospace;
            background: #000;
            color: #fff;
            min-height: 100vh;
            padding: 2rem;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
        }
        
        .header {
            text-align: center;
            margin-bottom: 2rem;
        }
        
        .title {
            font-size: 3rem;
            font-weight: bold;
            letter-spacing: 0.1em;
            margin-bottom: 0.5rem;
        }
        
        .title-gray {
            color: #6b7280;
        }
        
        .subtitle {
            color: #6b7280;
            letter-spacing: 0.2em;
            font-size: 0.875rem;
        }
        
        .tagline {
            color: #4b5563;
            font-size: 0.75rem;
            font-style: italic;
            margin-top: 0.5rem;
        }
        
        .control-panel {
            background: #111827;
            border: 1px solid #374151;
            padding: 1.5rem;
            margin-bottom: 1.5rem;
        }
        
        .buttons {
            display: flex;
            gap: 1rem;
            justify-content: center;
            margin-bottom: 1.5rem;
        }
        
        button {
            background: #374151;
            color: #fff;
            border: 1px solid #6b7280;
            padding: 0.75rem 2rem;
            font-family: 'Courier New', monospace;
            font-weight: bold;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 0.5rem;
            transition: background 0.2s;
        }
        
        button:hover {
            background: #4b5563;
        }
        
        .status {
            text-align: center;
            margin-bottom: 1rem;
        }
        
        .section-name {
            font-size: 1.5rem;
            font-weight: bold;
            color: #d1d5db;
            margin-bottom: 0.5rem;
        }
        
        .bar-info {
            font-size: 0.875rem;
            color: #6b7280;
            margin-bottom: 1rem;
        }
        
        .progress-bar-container {
            width: 100%;
            height: 12px;
            background: #1f2937;
            border-radius: 9999px;
            overflow: hidden;
            cursor: pointer;
            margin-bottom: 1rem;
            position: relative;
        }
        
        .progress-bar {
            height: 100%;
            background: linear-gradient(to right, #4b5563, #9ca3af, #4b5563);
            transition: width 0.3s;
        }
        
        .structure-list {
            margin-bottom: 1.5rem;
        }
        
        .structure-title {
            font-size: 0.875rem;
            color: #9ca3af;
            margin-bottom: 0.5rem;
        }
        
        .structure-item {
            padding: 0.5rem;
            border: 1px solid #1f2937;
            background: #000;
            color: #6b7280;
            font-size: 0.75rem;
            margin-bottom: 0.25rem;
        }
        
        .structure-item.active {
            background: #374151;
            border-color: #6b7280;
            color: #fff;
        }
        
        .themes-box {
            background: #000;
            padding: 1rem;
            border: 1px solid #1f2937;
        }
        
        .themes-title {
            font-size: 0.875rem;
            font-weight: bold;
            color: #9ca3af;
            margin-bottom: 0.5rem;
        }
        
        .theme-item {
            font-size: 0.75rem;
            color: #6b7280;
            margin-bottom: 0.25rem;
        }
        
        .theme-value {
            color: #d1d5db;
        }
        
        .info-box {
            background: #111827;
            padding: 1rem;
            border: 1px solid #374151;
            font-size: 0.875rem;
            color: #9ca3af;
        }
        
        .info-title {
            color: #fff;
            font-weight: bold;
            margin-bottom: 0.5rem;
        }
        
        .info-list {
            list-style: none;
            font-size: 0.75rem;
            margin-left: 0.5rem;
        }
        
        .info-list li {
            margin-bottom: 0.25rem;
        }
        
        .footer-text {
            margin-top: 0.75rem;
            font-size: 0.75rem;
        }

        @media (max-width: 768px) {
            .title {
                font-size: 2rem;
            }
            
            .buttons {
                flex-direction: column;
            }
            
            button {
                width: 100%;
                justify-content: center;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1 class="title">
                <span class="title-gray">PROTEIN</span>
                <span>CONTROL</span>
            </h1>
            <p class="subtitle">E. COLI RNA POLYMERASE</p>
            <p class="tagline">when molecular regulation fails</p>
        </div>

        <div class="control-panel">
            <div class="buttons">
                <button id="playBtn">
                    <span id="playIcon">â–¶</span>
                    <span id="playText">PLAY</span>
                </button>
                <button id="resetBtn">
                    <span>â†»</span>
                    <span>RESET</span>
                </button>
            </div>

            <div id="statusSection" style="display: none;">
                <div class="status">
                    <div class="section-name" id="sectionName"></div>
                    <div class="bar-info" id="barInfo"></div>
                    <div class="progress-bar-container" id="progressContainer">
                        <div class="progress-bar" id="progressBar"></div>
                    </div>
                </div>
            </div>

            <div class="structure-list">
                <div class="structure-title">SONG STRUCTURE:</div>
                <div id="structureList"></div>
            </div>

            <div class="themes-box">
                <div class="themes-title">MUSICAL THEMES:</div>
                <div id="themesList"></div>
            </div>
        </div>

        <div class="info-box">
            <p class="info-title">COMPOSITION:</p>
            <ul class="info-list">
                <li>â†’ TEMPO: 143 BPM (fast, urgent, relentless)</li>
                <li>â†’ BASS: Fast 8th notes, synth-like, driving</li>
                <li>â†’ GUITAR: Minimal, cold texture</li>
                <li>â†’ SYNTH: Dark, oppressive pads with tension</li>
                <li>â†’ DRUMS: Steady, mechanical (Stephen Morris style)</li>
                <li>â†’ STRUCTURE: Verse/Chorus with breakdown</li>
                <li>â†’ MOOD: Anxious, out of control, mechanical</li>
            </ul>
            <p class="footer-text">The protein drives a relentless, anxious rhythm inspired by post-punk urgency. Fast, mechanical, with no escape - biology meets loss of control. ðŸ§¬âš¡</p>
        </div>
    </div>

    <script>
        const proteinSequence = "MSIKLNLKDNNIEFVTGRGGGLRFKPKELNKLFGVHPPQSPYLASLRNLDYSDKQTLKEVLTMGADVRLHYEIADGFSRGVTYNSNEIILEYFQSDFSLPFLEEAIKSIGNLSFADLVGFTGTHLGFLSQVKNLPKNIQIIGIQAPNYAFMTLADTRVLNHGIYIDETIVAKNRMFESYQEGLPVTLQWKQVNSDKQRYLLSEREEISDLLHGTVAIEMLLKGKPLEIIADVSEVIDTRTKEQFAQLYNKLRPLKPWSHLKHLPVHDQSAPTVLSLPSKLIGELISVVQVPQDWTTWFDQLLFKRVIPLTGELQVTNRNTAIVRMKAIEPELKFYRRQVTEEEVKSEHGLFVPQTGRCYFPGEVEALGFYQHSAEDLVVKLTLTPSNPQTDIHDLLKDTVEAGRLAFDVAQQKNGLTLVNAIKKEKQNSLGTDDIESFKVPVFDSTESRMMVPGKSITAILEQVYGGQPLGDKVVQLVGDHITNGTKPHILKKIKITTKDIEAKLKEQLDLLKDQLKNPFIQHGHILMFDRNTGWQSLTVSDEGQRVLGVKPQVQVSQEMVFDALKSSADLSKKLHRDANQQGPRFVMHSIKVSPKHVGHEVVTFNIPDYVRQYNADVNGYNMKFVEGIHVEYLPGDVVGVMDADQTNLYEVNRKTLELREGTDPEQDLEQIRDGITRIEVPEVEKTLKQMKEISDLEKEVDYDTPLVVLDIIMDDTVVAEVDKIVHVPEFAVQNSFFGKNLSYQNFKDMVKKRQ";

        const noteMap = {
            'L': 110, 'E': 123.47, 'K': 130.81, 'I': 146.83, 'V': 164.81,
            'D': 174.61, 'A': 185, 'G': 196, 'T': 207.65, 'S': 220,
            'R': 233.08, 'N': 246.94, 'Q': 261.63, 'F': 277.18, 'Y': 293.66,
            'P': 311.13, 'H': 329.63, 'M': 349.23, 'C': 369.99, 'W': 392
        };

        const songStructure = [
            { name: 'INTRO', bars: 4, drums: 'minimal', fadeIn: true },
            { name: 'VERSE', bars: 8, drums: 'steady' },
            { name: 'CHORUS', bars: 8, drums: 'full' },
            { name: 'VERSE', bars: 4, drums: 'steady', variation: true },
            { name: 'BREAKDOWN', bars: 4, drums: 'breakdown' },
            { name: 'CHORUS', bars: 8, drums: 'full', intense: true },
            { name: 'OUTRO', bars: 6, drums: 'decay', fadeOut: true }
        ];

        let isPlaying = false;
        let audioContext = null;
        let oscillators = [];
        let intervalId = null;
        let currentBar = 0;
        let currentSection = '';

        function analyzeProtein() {
            const aaFreqs = {};
            proteinSequence.split('').forEach(aa => {
                aaFreqs[aa] = (aaFreqs[aa] || 0) + 1;
            });
            
            const sorted = Object.entries(aaFreqs).sort((a, b) => b[1] - a[1]);
            return {
                bassTheme: sorted[0][0],
                guitarTheme: sorted[1][0],
                leadTheme: sorted[2][0],
                padTheme: sorted[3][0]
            };
        }

        const themes = analyzeProtein();

        function initUI() {
            const structureHtml = songStructure.map((section, idx) => 
                `<div class="structure-item" data-index="${idx}">
                    ${section.name} - ${section.bars} bars (${section.drums})
                </div>`
            ).join('');
            document.getElementById('structureList').innerHTML = structureHtml;

            const themesHtml = `
                <div class="theme-item">BASS (Peter Hook): <span class="theme-value">${themes.bassTheme}</span> at ${Math.round(noteMap[themes.bassTheme] / 2)}Hz</div>
                <div class="theme-item">GUITAR (Bernard Sumner): <span class="theme-value">${themes.guitarTheme}</span> at ${Math.round(noteMap[themes.guitarTheme])}Hz</div>
                <div class="theme-item">LEAD MELODY: <span class="theme-value">${themes.leadTheme}</span> at ${Math.round(noteMap[themes.leadTheme] * 1.5)}Hz</div>
                <div class="theme-item">SYNTH PAD: <span class="theme-value">${themes.padTheme}</span> at ${Math.round(noteMap[themes.padTheme])}Hz</div>
            `;
            document.getElementById('themesList').innerHTML = themesHtml;
        }

        function makeDistortionCurve(amount) {
            const samples = 44100;
            const curve = new Float32Array(samples);
            const deg = Math.PI / 180;
            for (let i = 0; i < samples; i++) {
                const x = (i * 2) / samples - 1;
                curve[i] = ((3 + amount) * x * 20 * deg) / (Math.PI + amount * Math.abs(x));
            }
            return curve;
        }

        function playBar(ctx, section, barInSection) {
            const oscs = [];
            const now = ctx.currentTime;
            const beatDuration = 60 / 143;

            let fadeInFactor = 1;
            let fadeOutFactor = 1;
            
            if (section.fadeIn) {
                fadeInFactor = Math.min(1, (barInSection + 1) / section.bars);
            }
            
            if (section.fadeOut) {
                fadeOutFactor = Math.max(0.1, 1 - (barInSection / section.bars));
            }

            const bassPattern = section.name === 'CHORUS' ? 
                               [0, 0.5, 1, 1.5, 2, 2.5, 3, 3.5] : 
                               [0, 1, 2, 3];
            bassPattern.forEach((beat) => {
                if (section.drums !== 'minimal' || barInSection > 1) {
                    const bassFreq = noteMap[themes.bassTheme] / 2;
                    
                    const bassGain = ctx.createGain();
                    bassGain.connect(ctx.destination);
                    let intensity = 0.13 * fadeInFactor * fadeOutFactor;
                    
                    bassGain.gain.setValueAtTime(intensity, now + beat * beatDuration);
                    bassGain.gain.exponentialRampToValueAtTime(0.01, now + beat * beatDuration + 0.35);

                    const bassDistortion = ctx.createWaveShaper();
                    bassDistortion.curve = makeDistortionCurve(35);
                    
                    const bassOsc = ctx.createOscillator();
                    bassOsc.type = 'sawtooth';
                    bassOsc.frequency.setValueAtTime(bassFreq, now + beat * beatDuration);
                    bassOsc.connect(bassDistortion);
                    bassDistortion.connect(bassGain);
                    bassOsc.start(now + beat * beatDuration);
                    bassOsc.stop(now + beat * beatDuration + 0.35);
                    oscs.push(bassOsc);
                }
            });

            if (section.name === 'CHORUS') {
                const guitarBeats = [0];
                
                guitarBeats.forEach(beat => {
                    const guitarFreq = noteMap[themes.guitarTheme];
                    
                    const guitarGain = ctx.createGain();
                    guitarGain.connect(ctx.destination);
                    let volume = 0.03 * fadeInFactor * fadeOutFactor;
                    
                    guitarGain.gain.setValueAtTime(volume, now + beat * beatDuration);
                    guitarGain.gain.exponentialRampToValueAtTime(0.001, now + beat * beatDuration + 1);

                    const guitarFilter = ctx.createBiquadFilter();
                    guitarFilter.type = 'lowpass';
                    guitarFilter.frequency.value = 900;
                    guitarFilter.Q.value = 1;
                    
                    const guitarOsc = ctx.createOscillator();
                    guitarOsc.type = 'sine';
                    guitarOsc.frequency.setValueAtTime(guitarFreq, now + beat * beatDuration);
                    guitarOsc.connect(guitarFilter);
                    guitarFilter.connect(guitarGain);
                    guitarOsc.start(now + beat * beatDuration);
                    guitarOsc.stop(now + beat * beatDuration + 1);
                    oscs.push(guitarOsc);
                });
            }

            if (section.name !== 'INTRO' || barInSection > 1) {
                const padGain = ctx.createGain();
                padGain.connect(ctx.destination);
                let padVolume = section.name === 'BREAKDOWN' ? 0.05 : 0.03;
                padVolume = padVolume * fadeInFactor * fadeOutFactor;
                
                padGain.gain.setValueAtTime(0, now);
                padGain.gain.linearRampToValueAtTime(padVolume, now + 0.8);

                const padFilter = ctx.createBiquadFilter();
                padFilter.type = 'lowpass';
                const filterFreq = section.fadeOut ? Math.max(150, 300 - barInSection * 30) : 280;
                padFilter.frequency.value = filterFreq;
                padFilter.Q.value = 1.8;
                
                [0.9995, 1.0005].forEach(detune => {
                    const padOsc = ctx.createOscillator();
                    padOsc.type = 'sine';
                    padOsc.frequency.setValueAtTime(noteMap[themes.padTheme] * detune, now);
                    padOsc.connect(padFilter);
                    padOsc.start(now);
                    padOsc.stop(now + beatDuration * 4);
                    oscs.push(padOsc);
                });
                
                padFilter.connect(padGain);
            }

            if (section.drums !== 'minimal') {
                const drumsActive = !section.fadeIn || barInSection > 3;
                
                if (drumsActive) {
                    const kickPattern = section.drums === 'breakdown' ? [0, 1.5, 3] : [0, 1, 2, 3];
                    kickPattern.forEach(beat => {
                        const kickGain = ctx.createGain();
                        kickGain.connect(ctx.destination);
                        let kickVolume = 0.18 * fadeOutFactor;
                        
                        kickGain.gain.setValueAtTime(kickVolume, now + beat * beatDuration);
                        kickGain.gain.exponentialRampToValueAtTime(0.01, now + beat * beatDuration + 0.3);

                        const kickOsc = ctx.createOscillator();
                        kickOsc.type = 'sine';
                        kickOsc.frequency.setValueAtTime(100, now + beat * beatDuration);
                        kickOsc.frequency.exponentialRampToValueAtTime(40, now + beat * beatDuration + 0.3);
                        kickOsc.connect(kickGain);
                        kickOsc.start(now + beat * beatDuration);
                        kickOsc.stop(now + beat * beatDuration + 0.3);
                        oscs.push(kickOsc);
                    });

                    [1, 3].forEach(beat => {
                        const snareGain = ctx.createGain();
                        snareGain.connect(ctx.destination);
                        let snareVolume = 0.12 * fadeOutFactor;
                        
                        snareGain.gain.setValueAtTime(snareVolume, now + beat * beatDuration);
                        snareGain.gain.exponentialRampToValueAtTime(0.01, now + beat * beatDuration + 0.15);

                        const snareOsc = ctx.createOscillator();
                        snareOsc.type = 'triangle';
                        snareOsc.frequency.setValueAtTime(180, now + beat * beatDuration);
                        snareOsc.connect(snareGain);
                        snareOsc.start(now + beat * beatDuration);
                        snareOsc.stop(now + beat * beatDuration + 0.15);
                        oscs.push(snareOsc);
                    });

                    if ((section.name === 'BRIDGE' || section.intense) && Math.random() > 0.4) {
                        const tomBeat = section.name === 'BRIDGE' ? 2.5 : 0.5;
                        const tomGain = ctx.createGain();
                        tomGain.connect(ctx.destination);
                        tomGain.gain.setValueAtTime(0.2, now + tomBeat * beatDuration);
                        tomGain.gain.exponentialRampToValueAtTime(0.01, now + tomBeat * beatDuration + 0.25);

                        const tomOsc = ctx.createOscillator();
                        tomOsc.type = 'sine';
                        tomOsc.frequency.setValueAtTime(90, now + tomBeat * beatDuration);
                        tomOsc.frequency.exponentialRampToValueAtTime(60, now + tomBeat * beatDuration + 0.25);
                        tomOsc.connect(tomGain);
                        tomOsc.start(now + tomBeat * beatDuration);
                        tomOsc.stop(now + tomBeat * beatDuration + 0.25);
                        oscs.push(tomOsc);
                    }

                    if (section.drums === 'full' || section.drums === 'building') {
                        const hihatPattern = 2;
                        for (let i = 0; i < hihatPattern; i++) {
                            const timing = now + (i * beatDuration * 4 / hihatPattern);
                            const hihatGain = ctx.createGain();
                            hihatGain.connect(ctx.destination);
                            let hihatVolume = 0.015 * fadeOutFactor;
                            
                            hihatGain.gain.setValueAtTime(hihatVolume, timing);
                            hihatGain.gain.exponentialRampToValueAtTime(0.001, timing + 0.05);

                            const bufferSize = ctx.sampleRate * 0.05;
                            const buffer = ctx.createBuffer(1, bufferSize, ctx.sampleRate);
                            const data = buffer.getChannelData(0);
                            for (let j = 0; j < bufferSize; j++) {
                                data[j] = Math.random() * 2 - 1;
                            }

                            const hihatFilter = ctx.createBiquadFilter();
                            hihatFilter.type = 'highpass';
                            hihatFilter.frequency.value = 10000;

                            const noise = ctx.createBufferSource();
                            noise.buffer = buffer;
                            noise.connect(hihatFilter);
                            hihatFilter.connect(hihatGain);
                            noise.start(timing);
                            oscs.push(noise);
                        }
                    }
                }
            }

            oscillators = oscs;
        }

        function startMusic() {
            const ctx = new (window.AudioContext || window.webkitAudioContext)();
            audioContext = ctx;
            isPlaying = true;
            currentBar = 0;

            let barIndex = 0;
            let structureIndex = 0;
            let barInSection = 0;
            
            const bpm = 143;
            const barDuration = (60 / bpm) * 4 * 1000;

            document.getElementById('statusSection').style.display = 'block';
            document.getElementById('playText').textContent = 'STOP';
            document.getElementById('playIcon').textContent = 'â¸';

            const id = setInterval(() => {
                if (structureIndex >= songStructure.length) {
                    stopMusic();
                    return;
                }

                const section = songStructure[structureIndex];
                currentSection = section.name;
                currentBar = barIndex;

                updateUI();
                playBar(ctx, section, barInSection);

                barInSection++;
                barIndex++;

                if (barInSection >= section.bars) {
                    barInSection = 0;
                    structureIndex++;
                }
            }, barDuration);

            intervalId = id;
        }

        function stopMusic() {
            if (intervalId) {
                clearInterval(intervalId);
                intervalId = null;
            }
            oscillators.forEach(osc => {
                try { osc.stop(); } catch (e) {}
            });
            if (audioContext) {
                audioContext.close();
                audioContext = null;
            }
            isPlaying = false;
            oscillators = [];
            document.getElementById('statusSection').style.display = 'none';
            document.getElementById('playText').textContent = 'PLAY';
            document.getElementById('playIcon').textContent = 'â–¶';
            
            document.querySelectorAll('.structure-item').forEach(item => {
                item.classList.remove('active');
            });
        }

        function updateUI() {
            const totalBars = songStructure.reduce((sum, s) => sum + s.bars, 0);
            
            document.getElementById('sectionName').textContent = currentSection;
            document.getElementById('barInfo').textContent = `BAR ${currentBar + 1} / ${totalBars}`;
            document.getElementById('progressBar').style.width = `${((currentBar + 1) / totalBars) * 100}%`;
            
            let accumulatedBars = 0;
            songStructure.forEach((section, idx) => {
                const item = document.querySelector(`[data-index="${idx}"]`);
                if (currentBar >= accumulatedBars && currentBar < accumulatedBars + section.bars) {
                    item.classList.add('active');
                } else {
                    item.classList.remove('active');
                }
                accumulatedBars += section.bars;
            });
        }

        document.getElementById('progressContainer').addEventListener('click', function(e) {
            if (!isPlaying) return;
            
            const rect = e.currentTarget.getBoundingClientRect();
            const x = e.clientX - rect.left;
            const percentage = x / rect.width;
            const totalBars = songStructure.reduce((sum, s) => sum + s.bars, 0);
            const targetBar = Math.floor(percentage * totalBars);
            
            if (intervalId) {
                clearInterval(intervalId);
            }
            oscillators.forEach(osc => {
                try { osc.stop(); } catch (e) {}
            });
            
            currentBar = targetBar;
            
            if (isPlaying && audioContext) {
                let barIndex = targetBar;
                let structureIndex = 0;
                let barInSection = 0;
                
                let accumulatedBars = 0;
                for (let i = 0; i < songStructure.length; i++) {
                    if (accumulatedBars + songStructure[i].bars > targetBar) {
                        structureIndex = i;
                        barInSection = targetBar - accumulatedBars;
                        break;
                    }
                    accumulatedBars += songStructure[i].bars;
                }
                
                const bpm = 143;
                const barDuration = (60 / bpm) * 4 * 1000;
                
                const id = setInterval(() => {
                    if (structureIndex >= songStructure.length) {
                        stopMusic();
                        return;
                    }

                    const section = songStructure[structureIndex];
                    currentSection = section.name;
                    currentBar = barIndex;

                    updateUI();
                    playBar(audioContext, section, barInSection);

                    barInSection++;
                    barIndex++;

                    if (barInSection >= section.bars) {
                        barInSection = 0;
                        structureIndex++;
                    }
                }, barDuration);

                intervalId = id;
            }
        });

        document.getElementById('playBtn').addEventListener('click', () => {
            if (isPlaying) {
                stopMusic();
            } else {
                startMusic();
            }
        });

        document.getElementById('resetBtn').addEventListener('click', () => {
            stopMusic();
        });

        initUI();
    </script>
</body>
</html>
